name: Stock Scan (Direct Excel)

# --- 关键：赋予写权限，允许创建 Release ---
permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    # 北京时间 17:00 (UTC 09:00)
    - cron: '0 9 * * 1-5'

jobs:
  run_scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      # 1. 获取当前日期 (为了给文件和标签命名)
      - name: Get Date
        id: date
        run: echo "today=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas numpy ta openpyxl requests tqdm scikit-learn
          
      - name: Run Script
        run: python main.py
        
      # 2. 创建发布版并上传 Excel (不再是 Artifacts)
      # 这里会自动把 .xlsx 文件挂载到 Release 页面
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          # 标签名，例如: Scan-20231027
          tag_name: Scan-${{ steps.date.outputs.today }}
          # 标题名
          name: 选股结果 ${{ steps.date.outputs.today }}
          # 上传所有 Excel 文件
          files: "*.xlsx"
          # 自动生成说明
          body: "这是今日的自动选股结果，请点击下方 Excel 文件直接下载。"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
