name: Stock Scan (Direct Excel)

permissions:
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 9 * * 1-5'

jobs:
  run_scan:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Get Date
        id: date
        run: echo "today=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install akshare pandas numpy ta openpyxl requests tqdm scikit-learn
          
      - name: Run Script
        run: python main.py
        
      # --- 新增调试步骤：列出所有文件 ---
      # 这样在日志里能看到到底生成了什么
      - name: Check Files
        run: ls -R
        
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        # 修改为 always()，即使脚本报错，只要生成了日志也上传
        if: always() 
        with:
          tag_name: Scan-${{ steps.date.outputs.today }}
          name: 选股结果 ${{ steps.date.outputs.today }}
          # 关键修改：同时上传 xlsx 和 txt (错误日志)
          files: |
            *.xlsx
            *.txt
          body: "请查看下方 Attachments 下载结果。如果是 txt 文件，说明运行出错了。"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
